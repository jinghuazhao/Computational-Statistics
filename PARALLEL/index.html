<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>PARALLEL - Computational Statistics</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/Bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/HTML.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/Java.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/JavaScript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/Perl.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/Python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/R.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">Computational Statistics</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link"></a>
                            </li>
                            <li class="navitem">
                                <a href="../AI/" class="nav-link">AI</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">SETUP <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../INSTALL/" class="dropdown-item">INSTALL</a>
</li>
                                    
<li>
    <a href="../LANGUAGES/" class="dropdown-item">LANGUAGES</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">PARALLEL</a>
</li>
                                    
<li>
    <a href="../REPRODUCE/" class="dropdown-item">REPRODUCE</a>
</li>
                                    
<li>
    <a href="../SYSTEMS/" class="dropdown-item">SYSTEMS</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RESOURCE <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Internet</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../Web/Flask/" class="dropdown-item">Flask</a>
</li>
            
<li>
    <a href="../Web/mythic-beasts/" class="dropdown-item">mythic-beasts</a>
</li>
            
<li>
    <a href="../Web/plumber/" class="dropdown-item">plumber</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../Web/Computing/" class="dropdown-item">Computing resources</a>
</li>
                                    
<li>
    <a href="../Web/Utilities/" class="dropdown-item">Utilities</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../LANGUAGES/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../REPRODUCE/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/jinghuazhao/Computational-Statistics" class="nav-link"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#parallel-computing" class="nav-link">Parallel computing</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#gnu-parallel" class="nav-link">GNU parallel</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sge" class="nav-link">SGE</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#slurm" class="nav-link">SLURM</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sge-to-slurm" class="nav-link">SGE to SLURM</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#examples" class="nav-link">EXAMPLES</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#job-scheduling" class="nav-link">Job scheduling</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="parallel-computing">Parallel computing</h1>
<p>Recent notes are available from <a href="https://cambridge-ceu.github.io/csd3/systems/ParallelComputing.html">https://cambridge-ceu.github.io/csd3/systems/ParallelComputing.html</a>.</p>
<h2 id="gnu-parallel">GNU parallel</h2>
<p>It has home <a href="https://www.gnu.org/software/parallel/">https://www.gnu.org/software/parallel/</a> -- note especially with its --env to pass environment variables.</p>
<p>Under Ubuntu, GNU parallel is easily installed as follows,</p>
<pre><code>sudo apt install parallel
</code></pre>
<p>Earlier version had issues with temporary direvtory, e.g., <a href="https://stackoverflow.com/questions/24398941/gnu-parallel-unlink-error">https://stackoverflow.com/questions/24398941/gnu-parallel-unlink-error</a>
if </p>
<pre><code class="language-bash">module load parallel/20131222
</code></pre>
<p>The latest, <a href="http://ftp.gnu.org/gnu/parallel/parallel-latest.tar.bz2">http://ftp.gnu.org/gnu/parallel/parallel-latest.tar.bz2</a>, can be used instead.</p>
<h2 id="sge">SGE</h2>
<p>Sun Grid Engine has a <a href="https://en.wikipedia.org/wiki/Oracle_Grid_Engine">wiki entry</a>.</p>
<p><a href="https://peteris.rocks/blog/sun-grid-engine-installation-on-ubuntu-server/">https://peteris.rocks/blog/sun-grid-engine-installation-on-ubuntu-server/</a>.</p>
<p>To delete SGE jobs shown in qstat, use </p>
<pre><code class="language-bash">qstat | grep $USER | cut -d&quot; &quot; -f1 | xargs qdel
</code></pre>
<p>Otherwise for a consecutive sequence we use qdel {id1..id2}.</p>
<h2 id="slurm">SLURM</h2>
<p>Under Ubuntu, it can be installed with</p>
<pre><code class="language-bash">sudo apt install slurm-client
</code></pre>
<p>General information is available from <a href="https://slurm.schedmd.com/">https://slurm.schedmd.com/</a>.</p>
<p>Job scheduling examples on CentOS 6 and RHEL 7, <a href="https://www.arc.ox.ac.uk/arc-systems-0">https://www.arc.ox.ac.uk/arc-systems-0</a>.</p>
<table>
<thead>
<tr>
<th>command</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>sacct</td>
<td>report job accounting information about active or completed jobs</td>
</tr>
<tr>
<td>salloc</td>
<td>allocate resources for a job in real time (typically used to allocate resources and spawn a shell, in which the srun command is used to launch parallel tasks)</td>
</tr>
<tr>
<td>sbatch</td>
<td>submit a job script for later execution (the script typically contains one or more srun commands to launch parallel tasks)</td>
</tr>
<tr>
<td>scancel</td>
<td>cancel a pending or running job</td>
</tr>
<tr>
<td>scontrol</td>
<td>hold, holdu, release, requeue, requeuehold, suspend and resume commands</td>
</tr>
<tr>
<td>sinfo</td>
<td>reports the state of partitions and nodes managed by Slurm (it has a variety of filtering, sorting, and formatting options)</td>
</tr>
<tr>
<td>squeue</td>
<td>reports the state of jobs (it has a variety of filtering, sorting, and formatting options), by default, reports the running jobs in priority order followed by the pending jobs in priority order</td>
</tr>
<tr>
<td>srun</td>
<td>used to submit a job for execution in real time</td>
</tr>
</tbody>
</table>
<p>e.g., squeue -u $USER -r; qstat -u $USER; also scontrol show config; scontrol show partition; scontrol show job [jobid] and sview</p>
<p>To see environmental variables, e.g., MaxArraySize, we use</p>
<pre><code class="language-bash">scontrol show config | sed -n '/^MaxArraySize/s/.*= *//p'
</code></pre>
<ul>
<li>job array, <a href="https://slurm.schedmd.com/job_array.html">https://slurm.schedmd.com/job_array.html</a></li>
<li>dependency, <a href="https://hpc.nih.gov/docs/job_dependencies.html">https://hpc.nih.gov/docs/job_dependencies.html</a></li>
<li>examples, &gt;https://github.com/statgen/SLURM-examples&gt;</li>
<li>temporary directories, <a href="https://help.rc.ufl.edu/doc/Temporary_Directories">https://help.rc.ufl.edu/doc/Temporary_Directories</a></li>
</ul>
<blockquote>
<p>When a SLURM job starts, the scheduler creates a temporary directory for the job on the compute node's local hard drive. This $SLURM_TMPDIR directory is very useful for jobs that need to use or generate a large number of small files, as the /ufrc parallel filesystem is optimized for large file streaming and is less suitable for small files.</p>
<p>The directory is owned by the user running the job. The path to the temporary directory is made available as the $SLURM_TMPDIR variable. At the end of the job, the temporary directory is automatically removed.</p>
<p>You can use the ${SLURM_TMPDIR} variable in job scripts to copy temporary data to the temporary job directory. If necessary, it can also be used as argument for applications that accept a temporary directory argument.</p>
<p>Many applications and programming languages use the $TMPDIR environment variable, if available, as the default temporary directory path. If this variable is not set, the applications will default to using the /tmp directory, which is not desirable. SLURM will set $TMPDIR to the same value as $SLURM_TMPDIR unless $TMPDIR has already been set, in which case it will be ignored. Check your job script(s) and shell initialization files like .bashrc and .bash_profile to make sure you do not have $TMPDIR set.</p>
<p>If a personal Singularity container is used, make sure that the $SINGULARITYENV_TMPDIR variable is set within the job to export the local scratch location into the Singularity container. </p>
</blockquote>
<p>Examples of an interactive session can be simply <code>sintr</code>, or</p>
<pre><code class="language-bash">srun -N1 -n1 -c6 -p short,medium,long -t 12:0:0 --pty bash -i
</code></pre>
<p>so that the earliest available partition will be used.</p>
<h2 id="sge-to-slurm">SGE to SLURM</h2>
<p>Conversion is documented at <a href="https://srcc.stanford.edu/sge-slurm-conversion">https://srcc.stanford.edu/sge-slurm-conversion</a>.</p>
<h2 id="examples">EXAMPLES</h2>
<p>We intended to convert a large number of PDF files (INTERVAL.*.manhattn.pdf) to PNG with smaller file sizes. To start, we build a file list,</p>
<pre><code class="language-bash">ls *pdf | \
sed 's/INTERVAL.//g;s/.manhattan.pdf//g' &gt; INTERVAL.list
</code></pre>
<p>We do this with GNU parallel as follows,</p>
<pre><code class="language-bash">cat INTERVAL.list | \
parallel -C' ' '
  echo {}
  pdftopng -r 300 INTERVAL.{}.manhattan.pdf
  mv {}-000001.png INTERVAL.{}.png
'
</code></pre>
<p>or with SLURM,</p>
<pre><code class="language-bash">#!/bin/bash

#SBATCH --ntasks=1
#SBATCH --job-name=pdftopng
#SBATCH --time=6:00:00
#SBATCH --cpus-per-task=8
#SBATCH --partition=short
#SBATCH --array=1-50
#SBATCH --output=work/pdftopng_%A_%a.out
#SBATCH --error=work/pdftopng_%A_%a.err
#SBATCH --export ALL

. /etc/profile.d/modules.sh
module load default-cardio
module load slurm
module load use.own

export p=$(awk 'NR==ENVIRON[&quot;SLURM_ARRAY_TASK_ID&quot;]' INTERVAL.list)
export TMPDIR=/scratch/jhz22/tmp

echo ${p}
pdftopng -r 300 INTERVAL.${p}.manhattan.pdf ${p}
mv ${p}-000001.png INTERVAL.${p}.png

</code></pre>
<p>This is a single parameter case and it is possible to allow for more parameters in both cases.</p>
<p>Note also that the option <code>--array=1-50</code> instructs the system to schedule jobs and in jobs with large memory usage it is more preferable to change to <code>--array 1-50%4</code> so that a maximum of four jobs will be run simultaneously.</p>
<h2 id="job-scheduling">Job scheduling</h2>
<p>echo "ls -l" | at 01:00</p>
<p>crontab.guru, <a href="https://crontab.guru/examples.html">https://crontab.guru/examples.html</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
